// Question sets by function - using verbatim evaluation questions
const questionsByFunction = {
    "Planning": [
        { id: "Q1", text: "MDP can effectively explain their category's P&L and tell a compelling business story through it.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q2", text: "To what extent does the participant demonstrate fluency in retail math and independently access key financial metrics?", area: "Job Knowledge", weight: 0.5 },
        { id: "Q3", text: "MDP can navigate and apply financial planning tools (e.g., PBC, ISB Forecasting, AOP, One-Time-Buy).", area: "Job Knowledge", weight: 0.5 },
        { id: "Q4", text: "MDP can understand and articulate the financial impact of decisions on their category, including budget and JBP alignment.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q5", text: "MDP produced high-quality deliverables that reflected strong attention to detail and accuracy.", area: "Quality of Work", weight: 0.2 },
        { id: "Q6", text: "MDP demonstrated problem-solving skills in their work, contributing meaningful insights or improvements to the team or their project.", area: "Quality of Work", weight: 0.2 },
        { id: "Q7", text: "MDP communicated clearly and effectively with team, stakeholders, and cross-functional partners throughout the rotation.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q8", text: "MDP demonstrated strong collaboration skills and contributed positively to team dynamics.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q9", text: "MDP consistently demonstrated initiative by proactively identifying opportunities, asking thoughtful questions, and seeking out ways to add value during the rotation.", area: "Initiative & Productivity", weight: 0.15 },
        { id: "Q10", text: "MDP maintained a high level of productivity while also effectively managing their time and responsibilities.", area: "Initiative & Productivity", weight: 0.15 }
    ],
    "Digital Merch": [
        { id: "Q1", text: "MDP demonstrated a clear understanding of the HAVE + FIND + LOVE + BUY framework and how it supports the digital purchase funnel at Sam's Club.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q2", text: "MDP can articulate how Digital Merchandising's strategy aligns with the broader Sam's Club strategy, particularly in accelerating the omni member experience.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q3", text: "MDP understands and can articulate how images and content impact SEO in Google.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q4", text: "MDP has a solid understanding of how items come to life on samsclub.com, from creation to discovery, checkout, and delivery.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q5", text: "MDP produced high-quality deliverables that reflected strong attention to detail and accuracy.", area: "Quality of Work", weight: 0.2 },
        { id: "Q6", text: "MDP demonstrated problem-solving skills in their work, contributing meaningful insights or improvements to the team or their project.", area: "Quality of Work", weight: 0.2 },
        { id: "Q7", text: "MDP communicated clearly and effectively with team, stakeholders, and cross-functional partners throughout the rotation.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q8", text: "MDP demonstrated strong collaboration skills and contributed positively to team dynamics.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q9", text: "MDP consistently demonstrated initiative by proactively identifying opportunities, asking thoughtful questions, and seeking out ways to add value during the rotation.", area: "Initiative & Productivity", weight: 0.15 },
        { id: "Q10", text: "MDP maintained a high level of productivity while also effectively managing their time and responsibilities.", area: "Initiative & Productivity", weight: 0.15 }
    ],
    "Replenishment": [
        { id: "Q1", text: "MDP demonstrates confidence in using dashboards and reporting tools across replenishment systems to identify demand accuracy and support decision-making.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q2", text: "MDP understands the importance of item creation and maintenance accuracy, and recognizes how errors in this process can impact club operations.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q3", text: "MDP applies strategies to improve forecast accuracy and shows an understanding of how demand planning decisions drive seasonal and short-term sell-through.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q4", text: "MDP demonstrates an understanding of the importance of collaboration between merchants and replenishment teams in strengthening inventory allocation and supporting club performance.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q5", text: "MDP produced high-quality deliverables that reflected strong attention to detail and accuracy.", area: "Quality of Work", weight: 0.2 },
        { id: "Q6", text: "MDP demonstrated problem-solving skills in their work, contributing meaningful insights or improvements to the team or their project.", area: "Quality of Work", weight: 0.2 },
        { id: "Q7", text: "MDP communicated clearly and effectively with team, stakeholders, and cross-functional partners throughout the rotation.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q8", text: "MDP demonstrated strong collaboration skills and contributed positively to team dynamics.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q9", text: "MDP consistently demonstrated initiative by proactively identifying opportunities, asking thoughtful questions, and seeking out ways to add value during the rotation.", area: "Initiative & Productivity", weight: 0.15 },
        { id: "Q10", text: "MDP maintained a high level of productivity while also effectively managing their time and responsibilities.", area: "Initiative & Productivity", weight: 0.15 }
    ],
    "Member's Mark": [
        { id: "Q1", text: "MDP demonstrates a clear understanding of the Member's Mark ambition and strategy, and can articulate how it connects to the broader Sam's Club strategy.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q2", text: "MDP demonstrated a strong understanding of the Member's Mark creative guidelines and contributed to delivering a consistent member experience through packaging and design.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q3", text: "MDP effectively engaged with member research and sensory testing processes, showing a clear understanding of how member insights inform product development.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q4", text: "MDP showed a solid grasp of cross-functional collaboration, including quality, sourcing, and brand line management, and how these functions align to support the Member's Mark strategy.", area: "Job Knowledge", weight: 0.5 },
        { id: "Q5", text: "MDP produced high-quality deliverables that reflected strong attention to detail and accuracy.", area: "Quality of Work", weight: 0.2 },
        { id: "Q6", text: "MDP demonstrated problem-solving skills in their work, contributing meaningful insights or improvements to the team or their project.", area: "Quality of Work", weight: 0.2 },
        { id: "Q7", text: "MDP communicated clearly and effectively with team, stakeholders, and cross-functional partners throughout the rotation.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q8", text: "MDP demonstrated strong collaboration skills and contributed positively to team dynamics.", area: "Communication Skills & Teamwork", weight: 0.15 },
        { id: "Q9", text: "MDP consistently demonstrated initiative by proactively identifying opportunities, asking thoughtful questions, and seeking out ways to add value during the rotation.", area: "Initiative & Productivity", weight: 0.15 },
        { id: "Q10", text: "MDP maintained a high level of productivity while also effectively managing their time and responsibilities.", area: "Initiative & Productivity", weight: 0.15 }
    ]
};

// API endpoint for live data
const API_BASE = window.location.origin;

// Privacy: Format names as "First Name L." for display
function formatNameForPrivacy(fullName) {
    if (!fullName || fullName === 'Anonymous' || fullName === 'N/A') {
        return fullName;
    }
    
    const nameParts = fullName.trim().split(' ');
    if (nameParts.length === 1) {
        return nameParts[0]; // Just first name if only one name provided
    }
    
    const firstName = nameParts[0];
    const lastNameInitial = nameParts[nameParts.length - 1].charAt(0).toUpperCase();
    return `${firstName} ${lastNameInitial}.`;
}

// Load questions based on selected function
function loadQuestions() {
    const functionName = document.getElementById('functionName').value;
    const container = document.getElementById('questionsContainer');
    
    if (!functionName) {
        container.innerHTML = '';
        return;
    }

    const questions = questionsByFunction[functionName];
    let html = '';

    questions.forEach((question, index) => {
        html += `
            <div class="question-group">
                <div class="question-text">${question.id}. ${question.text}</div>
                <div class="question-meta">Assessment Area: ${question.area} (Weight: ${(question.weight * 100).toFixed(0)}%)</div>
                <div class="rating-scale">
                    ${[1, 2, 3, 4, 5].map(rating => {
                        const labels = ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
                        return `
                        <div class="rating-option">
                            <input type="radio" id="${question.id}_${rating}" name="${question.id}" value="${rating}" required>
                            <label for="${question.id}_${rating}">${rating}<br>${labels[rating-1]}</label>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Check what rotation this will be for the selected MDP
async function checkNextRotation() {
    const mdpName = document.getElementById('mdpName').value;
    if (!mdpName) {
        // Reset function dropdown to default if no MDP selected
        resetFunctionDropdown();
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/api/survey-responses`);
        const data = await response.json();
        
        const existingSurveys = data.filter(item => item.mdpName === mdpName);
        const nextRotation = existingSurveys.length + 1;
        
        // Get functions already completed by this MDP
        const completedFunctions = existingSurveys.map(survey => survey.functionName);
        
        // Show rotation info
        const rotationInfo = document.getElementById('rotationInfo');
        if (rotationInfo) {
            let infoText = `This will be Rotation ${nextRotation} for ${formatNameForPrivacy(mdpName)}`;
            if (completedFunctions.length > 0) {
                infoText += `\nPrevious functions: ${completedFunctions.join(', ')}`;
            }
            rotationInfo.textContent = infoText;
            rotationInfo.style.display = 'block';
            rotationInfo.style.whiteSpace = 'pre-line'; // Allow line breaks
        }
        
        // Update function dropdown to disable completed functions
        updateFunctionDropdown(completedFunctions);
        
    } catch (error) {
        console.error('Error checking rotation:', error);
        resetFunctionDropdown();
    }
}

// Update function dropdown to disable completed functions
function updateFunctionDropdown(completedFunctions = []) {
    const functionSelect = document.getElementById('functionName');
    const allFunctions = ['Planning', 'Digital Merch', 'Replenishment', "Member's Mark"];
    
    // Clear existing options
    functionSelect.innerHTML = '<option value="">Select Function</option>';
    
    // Add options, disabling completed functions
    allFunctions.forEach(func => {
        const option = document.createElement('option');
        option.value = func;
        
        if (completedFunctions.includes(func)) {
            option.textContent = `${func} (Already Completed)`;
            option.disabled = true;
            option.style.color = '#999';
            option.style.fontStyle = 'italic';
        } else {
            option.textContent = func;
        }
        
        functionSelect.appendChild(option);
    });
    
    // Clear the selected function and questions if current selection is now disabled
    if (completedFunctions.includes(functionSelect.value)) {
        functionSelect.value = '';
        loadQuestions();
    }
}

// Reset function dropdown to default state
function resetFunctionDropdown() {
    const functionSelect = document.getElementById('functionName');
    functionSelect.innerHTML = `
        <option value="">Select Function</option>
        <option value="Planning">Planning</option>
        <option value="Digital Merch">Digital Merchandising</option>
        <option value="Replenishment">Replenishment</option>
        <option value="Member's Mark">Member's Mark</option>
    `;
    functionSelect.value = '';
    loadQuestions();
    
    // Hide rotation info
    const rotationInfo = document.getElementById('rotationInfo');
    if (rotationInfo) {
        rotationInfo.style.display = 'none';
    }
}

// Submit survey
async function submitSurvey(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const successMsg = document.getElementById('successMessage');
    const errorMsg = document.getElementById('errorMessage');
    
    // Hide previous messages
    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
        const formData = new FormData(event.target);
        const functionName = formData.get('functionName');
        const questions = questionsByFunction[functionName];
        
        // Build responses object
        const responses = {};
        questions.forEach(question => {
            responses[question.id] = parseInt(formData.get(question.id)) || 0;
        });

        // Calculate scores
        const jobKnowledge = calculateAverage(responses, 'Job Knowledge', questions);
        const qualityOfWork = calculateAverage(responses, 'Quality of Work', questions);
        const communication = calculateAverage(responses, 'Communication Skills & Teamwork', questions);
        const initiative = calculateAverage(responses, 'Initiative & Productivity', questions);
        const overall = calculateOverallScore(responses, questions);

        const surveyData = {
            mdpName: formData.get('mdpName') || 'Anonymous',
            functionName: functionName || 'General',
            manager: formData.get('manager') || 'Not specified',
            // rotation will be auto-assigned by server
            responses: responses,
            submittedAt: new Date().toISOString(),
            jobKnowledge: jobKnowledge,
            qualityOfWork: qualityOfWork,
            communication: communication,
            initiative: initiative,
            overall: overall,
            emailResponse: document.getElementById('emailResponse').checked,
            respondentEmail: document.getElementById('respondentEmail').value || null
        };

        // Submit to server
        const response = await fetch(`${API_BASE}/api/survey-responses`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(surveyData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Survey submitted:', result);
        
        // Redirect to success page instead of showing message
        window.location.href = 'success.html';

    } catch (error) {
        console.error('Error submitting survey:', error);
        errorMsg.textContent = 'Error submitting survey. Please try again.';
        errorMsg.style.display = 'block';
        errorMsg.scrollIntoView({ behavior: 'smooth' });
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Evaluation';
    }
}

// Helper function to calculate average score for an area
function calculateAverage(responses, area, questions) {
    const areaQuestions = questions.filter(q => q.area === area);
    if (areaQuestions.length === 0) return 0;
    
    const sum = areaQuestions.reduce((total, q) => {
        return total + (parseInt(responses[q.id]) || 0);
    }, 0);
    
    return parseFloat((sum / areaQuestions.length).toFixed(2));
}

// Helper function to calculate overall weighted score
function calculateOverallScore(responses, questions) {
    const areas = [
        { name: 'Job Knowledge', weight: 0.50 },
        { name: 'Quality of Work', weight: 0.20 },
        { name: 'Communication Skills & Teamwork', weight: 0.15 },
        { name: 'Initiative & Productivity', weight: 0.15 }
    ];
    
    let weightedTotal = 0;
    let totalWeight = 0;
    
    areas.forEach(area => {
        const score = calculateAverage(responses, area.name, questions);
        if (score > 0) {
            weightedTotal += score * area.weight;
            totalWeight += area.weight;
        }
    });
    
    return totalWeight > 0 ? parseFloat((weightedTotal / totalWeight).toFixed(2)) : 0;
}
// Event listeners
document.getElementById('functionName').addEventListener('change', loadQuestions);
document.getElementById('surveyForm').addEventListener('submit', submitSurvey);

// Email checkbox toggle
document.getElementById('emailResponse').addEventListener('change', function() {
    const emailInput = document.getElementById('emailInput');
    emailInput.style.display = this.checked ? 'block' : 'none';
    if (!this.checked) {
        document.getElementById('respondentEmail').value = '';
    }
});

// Initialize
loadQuestions();